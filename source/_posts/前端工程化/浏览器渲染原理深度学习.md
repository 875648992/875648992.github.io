---
title: 浏览器渲染原理深度学习
tags: [面试题]
date: 2022-09-31 16:09:29
categories: [面试题]
---

## 啥叫渲染`render`

在浏览器中`html字符串 - 渲染 -> 屏幕上的像素信息`

> 就好比在**url地址栏上输入一串地址** , 普通人可以直接说访问到了对应的网站 
-  但是身为一个前端工程师却不能这么看,你必须要搞懂这里面的原因才行,拿我们输入url拿到的是什么呢?拿到的其实是这么一个玩意
- 拿到的是一个字符串 **html,css,js**都在这个字符串里面

![在这里插入图片描述](https://img-blog.csdnimg.cn/ec1bd475a90047f49b9eee21276c3b66.png)
- 浏览器就会根据这个字符串去进行复杂的计算每个像素处于页面中什么位置 , 什么颜色 .....

```javascript
// 其实就是类似这样处理了  传入一个html字符串去函数内部计算
function render(html){
	// 第一行第一个像素什么颜色,第二个,第三个..
	// 第二行第一个像素什么颜色,第二个,第三个..
	return pixels // 最后返回计算结果交给交给GPU , 显卡 就完成了一次渲染
}
```
## 浏览器是如何渲染页面的
>   经常听到一到高频的面试题 : 
>  浏览器URl地址栏输入后发生了什么?
 -  总结起来就两步
 -- 网络 : 拿HTML
 -- 渲染: 拿到后渲染
####  下面详细讲一下渲染这一步
 >  - 首先在浏览器中网络线程经过通信拿到html文档后 , 然后会产生一个渲染任务,并将其传递给渲染主线程的消息队列
> - 在事件循环机制的作用下 , 渲染主线程取出消息队列中的渲染任务, 开启渲染流程

#### 渲染流水线
`HTML字符串` --> `解析HTML` --> `样式计算` --> `布局` --> `分层` --> `绘制` --> `分块` --> `光栅化` --> `画` --> `图像`

#### 解析HTML `Parse HTML`
- 把一个html字符串解析的时候 , 会产生两个对象结构的**树**
![在这里插入图片描述](https://img-blog.csdnimg.cn/e766a88d58c748f38e0c3d03945f90af.png)
- HTML解析过程中遇到CSS代码怎么办呢?
-- 为了提高解析效率 , 浏览器会启动一个`预解析器`率先下载和解析css
-- 所以css不会阻塞html解析 , 因为css解析是跑在开辟出的一个预解析线程里
![在这里插入图片描述](https://img-blog.csdnimg.cn/0b9b9b6c62514e3bba0582e5f5fa9f40.png)
> - 解析过程中遇到css解析css, 遇到js执行js. 为了提高解析效率 , 浏览器开始解析之前 , 会启动一个预解析的线程 , 率先下载HTML中的外部css文件和外部的js文件
>  - 如果主线程解析到`link`位置 , 此时外部的css文件还没有下载解析好 , 主线程不会等待 , 继续解析后续的HTML , 这是因为下载和解析css的工作是在预解析进程中进行的 , 这就是css不会阻塞HTML的根本原因
>   - 如果主线程解析到`script`位置 , 会停止解析HTML,转而等待JS文件下载好,并将全局的代码解析执行完成后, 才能继续解析HTML, 这是因为JS代码的执行过程中可能会修改当前的DOM树,所以DOM树的生成必须暂停 , 这就是JS会阻塞HTML解析的根本原因
-  第一步完成后 , 会得到DOM树和CSSOM树 , 浏览器的默认样式 , 内部样式 , 外部样式 , 行内样式均会包含在CSSOM树中

### 样式的计算
> 渲染的下一步是样式的计算

> 主线程会遍历得到的dom树 , 依次为树中的每个节点计算出它的最终样式 , 称之为computed Style ,
> 
> 在这一过程中 , 很多预设值会变成绝对值 , 比如`red`会变成`rgb(255,0,0)`;相对单位会变成绝对单位 , 比如`em`会变成`px`
> 
> 这一步完成后 , 会得到一颗带有样式的dom树

### 布局
> 布局完之后会得到布局树
>
>布局阶段会依次遍历dom树的每个节点 , 计算每个节点的几何信息 , 列如节点的宽高 , 相对包含块的位置
>
>大部分之后 , dom树和布局树并非一一对应
> 
> -  比如`display:none`的节点没有几何信息 , 因此不会生成到布局树 ; 又比如使用了伪元素选择器 , 虽然dom树中不存在这些伪元素节点 , 但他们拥有几何信息, 所以会生成到布局树中 . 还有匿名行盒, 匿名块盒等等都会导致dom树和布局树无法一一对应

### 分层
 > 主线程会使用一天复杂的策略对整个布局树中进行分层
 >  
 >  分层的好处在于,将来某一个层改变后 ,仅会对该层进行后续的处理 , 从而提高效率
 >   
 >   滚动条 , 堆叠上下文 , transform....等样式都会或多或少的影响分层的结果 , 也可以通过`will-change`属性更大程度的影响分层的结果
![在这里插入图片描述](https://img-blog.csdnimg.cn/83e7f0aed368444988738e8b1cd4acc7.png)
![在这里插入图片描述](https://img-blog.csdnimg.cn/d1807793a3c043a9a1d9a5960b1b636f.png)


### 绘制